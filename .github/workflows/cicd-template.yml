name: ğŸŒ Global CI/CD Template
on:
  workflow_call:
    inputs:
      java-version:
        description: 'JDK version'
        type: string
        default: '17'
      target-branch:
        description: 'Target branch'
        type: string
        default: 'develop'
      artifact-prefix:
        description: 'Artifact prefix (from pom.xml)'
        type: string
        default: 'project'
      version-prefix:
        description: 'Release version prefix'
        type: string
        default: 'v1.0.'

jobs:
  # 1. CODE REVIEW (Bloquea todo si falla)
  code-review:
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.review.outcome == 'success' }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ” Code Review (Falla â†’ bloquea JAR)
        id: review
        run: |
          mvn clean compile \
            spotbugs:spotbugs \
            pmd:pmd \
            checkstyle:check || exit 1

      - name: ğŸ Setup Python 3.11
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”„ Convertir XML â†’ JSON
        if: always()
        run: |
          pip install xmltodict
          
          python3 -c "
          import xmltodict, json
          with open('target/spotbugsXml.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/spotbugs.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… spotbugs.json OK')
          "
          
          python3 -c "
          import xmltodict, json
          with open('target/pmd.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/pmd.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… pmd.json OK')
          "
          
          python3 -c "
          import xmltodict, json
          with open('target/checkstyle-result.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/checkstyle.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… checkstyle.json OK')
          "
          
          echo "ğŸ“ Archivos JSON generados:"
          ls -la target/*.json
      
      - name: ğŸ“¦ Subir Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-reports-${{ github.run_number }}"
          path: |
            target/spotbugs*.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle*.xml
            target/checkstyle.json
          retention-days: 7
      
      - name: ğŸš¨ Release Errores
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.artifact-prefix }}-errors-${{ github.run_number }}"
          name: "ğŸš¨ Errores ${{ inputs.artifact-prefix }} #${{ github.run_number }}"
          draft: false
          prerelease: true
          files: |
            target/spotbugsXml.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle-result.xml
            target/checkstyle.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. BUILD JAR (CORREGIDO âœ…)
  build:
    runs-on: ubuntu-latest
    needs: code-review
    if: needs.code-review.outputs.passed == 'true'
    outputs:
      artifact_name: ${{ inputs.artifact-prefix }}  # â† SIMPLE
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ—ï¸ Compilar JAR
        run: mvn -B clean package -DskipTests
      
      - name: ğŸ“¦ Subir JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-jar-${{ github.run_number }}"
          path: target/*.jar    # â† âœ… Spring Boot executable incluido

  # 3. RELEASE JAR
  release:
    runs-on: ubuntu-latest
    needs: [code-review, build]
    if: needs.build.result == 'success'
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Descargar JAR desde Build
        uses: actions/download-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-jar-${{ github.run_number }}"
          path: artifacts/
      
      - name: ğŸš€ Crear Release JAR PÃšBLICO
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.version-prefix }}${{ github.run_number }}"
          name: "${{ inputs.artifact-prefix }} ${{ inputs.version-prefix }}${{ github.run_number }}"
          body: |
            âœ… **${{ inputs.artifact-prefix }} ${{ inputs.version-prefix }}${{ github.run_number }}**
            
            **ğŸ“¦ JAR Asset disponible:**
            - `${{ needs.build.outputs.artifact_name }}-*.jar`
            
            **Pipeline Status:**
            - Code Review: âœ… Passed
            - Build JAR: âœ… Success
            - Run Number: #${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.jar  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 4. COMENTARIO FINAL EN PR
  comment:
  runs-on: ubuntu-latest
  needs: [code-review, build, release]
  steps:
    - name: ğŸ’¬ Status Final PR
      if: always()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: "ğŸš¦ gitactionsJava1 CI/CD Pipeline"
        message: |
          ## ğŸ“Š **gitactionsJava1 Pipeline Results**
          | Job | Status |
          |-----|--------|
          | ğŸ” **Code Review** | ${{ needs.code-review.result }} |
          | ğŸ—ï¸ **Build JAR** | ${{ needs.build.result || 'â¸ï¸ Bloqueado' }} |
          | ğŸš€ **Release** | ${{ needs.release.result || 'â¸ï¸ Bloqueado' }} |

          ${{ 
            (needs.code-review.outputs.passed == 'true' && needs.release.result == 'success') && 
            format('âœ… **JAR PUBLICADO v1.0.%d** ğŸš€ https://github.com/BEstr-Fullm4n/gitactionsJava1/releases/tag/v1.0.%d', github.run_number, github.run_number) || 
            needs.code-review.outputs.passed != 'true' && 
            format('ğŸ”´ **Code Review FALLÃ“** â†’ Revisa `gitactionsJava1-reports-%d` en Artifacts', github.run_number) || 
            '## â³ **Pipeline ejecutÃ¡ndose...**'
          }}

