name: ğŸŒ Global CI/CD Template
on:
  workflow_call:
    inputs:
      java-version:
        description: 'JDK version'
        type: string
        default: '17'
      target-branch:
        description: 'Target branch'
        type: string
        default: 'develop'
      artifact-prefix:
        description: 'Artifact prefix (from pom.xml)'
        type: string
        default: 'project'
      version-prefix:
        description: 'Release version prefix'
        type: string
        default: 'v1.0.'

jobs:

  # 1. VALIDAR RAMA (NUEVO - BLOQUEA TODO)
  validate-branch:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.length_ok }}
    steps:
      - name: ğŸ“ Verificar longitud rama < 64 chars
        id: check
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          LENGTH=${#BRANCH_NAME}
          
          echo "ğŸ“ Rama: '$BRANCH_NAME' â†’ $LENGTH caracteres"
          
          if [ $LENGTH -ge 64 ]; then
            echo "âŒ ERROR: Rama excede 64 caracteres"
            echo "length_ok=false" >> $GITHUB_OUTPUT
            echo ":::error::âŒ Rama '$BRANCH_NAME' tiene $LENGTH chars (MAX 64)" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Rama OK: $LENGTH chars"
            echo "length_ok=true" >> $GITHUB_OUTPUT
          fi

  # 2. CODE REVIEW (Bloquea todo si falla)
  code-review:
    runs-on: ubuntu-latest
    needs: [validate-branch]           # â† DEPENDENCIA
    if: needs.validate-branch.outputs.valid == 'true'  # â† CONDICIÃ“N
    outputs:
      passed: ${{ steps.review.outcome == 'success' }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ” Code Review (Falla â†’ bloquea JAR)
        id: review
        run: |
          mvn clean compile \
            spotbugs:spotbugs \
            pmd:pmd \
            checkstyle:check || exit 1

      - name: ğŸ Setup Python 3.11
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”„ Convertir XML â†’ JSON
        if: always()
        run: |
          pip install xmltodict
          
          python3 -c "
          import xmltodict, json
          with open('target/spotbugsXml.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/spotbugs.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… spotbugs.json OK')
          "
          
          python3 -c "
          import xmltodict, json
          with open('target/pmd.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/pmd.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… pmd.json OK')
          "
          
          python3 -c "
          import xmltodict, json
          with open('target/checkstyle-result.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/checkstyle.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… checkstyle.json OK')
          "
          
          echo "ğŸ“ Archivos JSON generados:"
          ls -la target/*.json
      
      - name: ğŸ“¦ Subir Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-reports-${{ github.run_number }}"
          path: |
            target/spotbugs*.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle*.xml
            target/checkstyle.json
          retention-days: 7
      
      - name: ğŸš¨ Release Errores
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.artifact-prefix }}-errors-${{ github.run_number }}"
          name: "ğŸš¨ Errores ${{ inputs.artifact-prefix }} #${{ github.run_number }}"
          draft: false
          prerelease: true
          files: |
            target/spotbugsXml.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle-result.xml
            target/checkstyle.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 3. BUILD JAR (CORREGIDO âœ…)
  build:
    runs-on: ubuntu-latest
    #needs: code-review
    #if: needs.code-review.outputs.passed == 'true'
    needs: [validate-branch, code-review]           # â† DEPENDENCIA
    if: needs.validate-branch.outputs.valid == 'true'  # â† CONDICIÃ“N
    outputs:
      artifact_name: ${{ inputs.artifact-prefix }}  # â† SIMPLE
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ—ï¸ Compilar JAR
        run: mvn -B clean package -DskipTests
      
      - name: ğŸ“¦ Subir JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-jar-${{ github.run_number }}"
          path: target/*.jar    # â† âœ… Spring Boot executable incluido

  # 4. RELEASE JAR
  release:
    runs-on: ubuntu-latest
    #needs: [code-review, build]
    #if: needs.build.result == 'success'
    needs: [validate-branch, code-review, build]           # â† DEPENDENCIA
    #if: needs.validate-branch.outputs.valid == 'true'  # â† CONDICIÃ“N
    if: needs.build.result == 'success'
    permissions:
      contents: write
    outputs:
      final_message: ${{ steps.msg.outputs.text }}
    steps:
      - name: ğŸ“¥ Descargar JAR desde Build
        uses: actions/download-artifact@v4
        with:
          name: "${{ inputs.artifact-prefix }}-jar-${{ github.run_number }}"
          path: artifacts/
      
      - name: ğŸš€ Crear Release JAR PÃšBLICO
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.version-prefix }}${{ github.run_number }}"
          name: "${{ inputs.artifact-prefix }} ${{ inputs.version-prefix }}${{ github.run_number }}"
          body: |
            âœ… **${{ inputs.artifact-prefix }} ${{ inputs.version-prefix }}${{ github.run_number }}**
            
            **ğŸ“¦ JAR Asset disponible:**
            - `${{ needs.build.outputs.artifact_name }}-*.jar`
            
            **Pipeline Status:**
            - Code Review: âœ… Passed
            - Build JAR: âœ… Success
            - Run Number: #${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.jar  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Preparar mensaje 
        id: msg 
        run: | 
          if [ "${{ needs.code-review.outputs.passed }}" = "true" ]; then 
            echo "text=âœ… **${{ inputs.artifact-prefix }} ${{ inputs.version-prefix }}${{ github.run_number }} PUBLICADO** ğŸš€ ğŸ“¥[![JAR Download](https://img.shields.io/badge/JAR-${{ inputs.version-prefix }}${{ github.run_number }}-brightgreen)](https://github.com/${{ github.repository }}/releases/tag/${{ inputs.version-prefix }}${{ github.run_number }})" >> $GITHUB_OUTPUT 
          elif [ "${{ needs.code-review.outputs.passed }}" != "true" ]; then 
            echo "text=ğŸ”´ **Code Review FALLÃ“** â†’ Revisa ${{ inputs.artifact-prefix }}-reports-${{ github.run_number }}" >> $GITHUB_OUTPUT 
          else 
            echo "text=## â³ **Pipeline ejecutÃ¡ndose...**" >> $GITHUB_OUTPUT 
          fi

  # 5. COMENTARIO FINAL EN PR
  comment:
    runs-on: ubuntu-latest
    needs: [code-review, build, release]
    outputs:  # â† AGREGAR ESTO
      passed: ${{ steps.review.outcome == 'success' }}
      artifact_prefix: ${{ inputs.artifact-prefix }}     # â† AGREGAR
      version_prefix: ${{ inputs.version-prefix }}       # â† AGREGAR
    steps:
      - name: ğŸ’¬ Status Final PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸš¦ ${{ inputs.artifact-prefix }} CI/CD Pipeline"
          message: |
            ## ğŸ“Š **${{ inputs.artifact-prefix }} Pipeline Results**
            | Job | Status |
            |-----|--------|
            | ğŸ” **Code Review** | ${{ needs.code-review.result }} |
            | ğŸ—ï¸ **Build JAR** | ${{ needs.build.result || 'â¸ï¸ Bloqueado' }} |
            | ğŸš€ **Release** | ${{ needs.release.result || 'â¸ï¸ Bloqueado' }} |

            ${{ needs.release.outputs.final_message }}

