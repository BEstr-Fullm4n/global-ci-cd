name: Global CI/CD Template
on:
  workflow_call:  # â† REUSABLE
    inputs:
      java-version:
        description: 'JDK version'
        type: string
        default: '17'
      branch:
        description: 'Target branch'
        type: string
        default: 'develop'
      artifact-name:
        description: 'Artifact name'
        type: string
        default: 'project'

jobs:

  # 1. CODE REVIEW (Bloquea todo si falla)
  code-review:
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.review.outcome == 'success' }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ” Code Review (Falla â†’ bloquea JAR)
        id: review
        run: |
          mvn clean compile \
            spotbugs:spotbugs \
            pmd:pmd \
            checkstyle:check || exit 1

      # Configurar Python 3.11
      - name: ğŸ Setup Python & Convertir XML â†’ JSON
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Convertir XML â†’ JSON
      - name: ğŸ”„ Convertir XML reports a JSON
        if: always()
        run: |
          pip install xmltodict
          
          # SpotBugs â†’ JSON (1 lÃ­nea)
          python3 -c "
          import xmltodict, json
          with open('target/spotbugsXml.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/spotbugs.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… spotbugs.json OK')
          "
          
          # PMD â†’ JSON (1 lÃ­nea)
          python3 -c "
          import xmltodict, json
          with open('target/pmd.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/pmd.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… pmd.json OK')
          "
          
          # Checkstyle â†’ JSON (1 lÃ­nea)
          python3 -c "
          import xmltodict, json
          with open('target/checkstyle-result.xml') as f:
              data = xmltodict.parse(f.read())
          with open('target/checkstyle.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('âœ… checkstyle.json OK')
          "
          
          echo "ğŸ“ Archivos JSON generados:"
          ls -la target/*.json
      
      # Assets como Artifacts (visible inmediatamente)
      - name: ğŸ“¦ Subir XML y JSON como Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-reports-${{ github.run_number }}
          path: |
            target/spotbugs*.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle*.xml
            target/checkstyle.json
          retention-days: 7
      
      # Opcional: Release pÃºblico con errores
      - name: ğŸš¨ Crear Release con Assets (Errores)
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: code-review-${{ github.run_number }}
          name: "ğŸš¨ Errores Code Review #${{ github.run_number }}"
          draft: false  # â† PÃšBLICO inmediatamente
          prerelease: false
          files: |
            target/spotbugsXml.xml
            target/spotbugs.json
            target/pmd.xml
            target/pmd.json
            target/checkstyle-result.xml
            target/checkstyle.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. BUILD JAR (SOLO si Code Review pasa)
  build:
    runs-on: ubuntu-latest
    needs: code-review
    if: needs.code-review.outputs.passed == 'true'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ—ï¸ Compilar JAR
        run: mvn -B clean package -DskipTests
      
      - name: ğŸ“¦ Subir JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitactions-jar-${{ github.run_number }}
          path: target/gitactions-*.jar

  # 3. RELEASE JAR (SOLO si build OK) - PUBLICADO EN ASSETS
  release:
    runs-on: ubuntu-latest
    needs: [code-review, build]
    if: needs.build.result == 'success'
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Descargar JAR desde Build
        uses: actions/download-artifact@v4
        with:
          name: gitactions-jar-${{ github.run_number }}
          path: target/
      
      - name: ğŸš€ Crear Release JAR PÃšBLICO en Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: "Release v1.0.${{ github.run_number }}"
          body: |
            âœ… **CI/CD COMPLETADO** - Code Review + Build OK
            
            **ğŸ“¦ JAR Asset disponible en Releases:**
            - `gitactions-*.jar`
            
            **Pipeline Status:**
            - Code Review: âœ… Passed
            - Build JAR: âœ… Success
            - Run Number: #${{ github.run_number }}
          draft: false      # â† PÃšBLICO inmediatamente
          prerelease: false # â† Release estable
          files: |
            target/gitactions-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 4. COMENTARIO FINAL EN PR
  comment:
    runs-on: ubuntu-latest
    needs: [code-review, build, release]
    steps:
      - name: ğŸ’¬ Status Final PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸš¦ CI/CD Pipeline Status"
          message: |
            ## ğŸ“Š **Pipeline Results**
            | Job | Status |
            |-----|--------|
            | ğŸ” Code Review | ${{ needs.code-review.result }} |
            | ğŸ—ï¸ Build | ${{ needs.build.result || 'â¸ï¸' }} |
            | ğŸš€ Release | ${{ needs.release.result || 'â¸ï¸' }} |

            ${{ 
              (needs.code-review.outputs.passed == 'true' && needs.release.result == 'success') && 
              format('# âœ… **JAR PUBLICADO v1.0.{0}** ğŸš€ ğŸ“¥[![JAR Download](https://img.shields.io/badge/JAR-v1.0.{0}-brightgreen)](https://github.com/BEstr-Fullm4n/repoActionsJava/releases/tag/v1.0.{0})', github.run_number) || 
              needs.code-review.outputs.passed != 'true' && '## ğŸ”´ **Code Review FALLÃ“** â†’ Revisa XML en Artifacts' || 
              '## â³ **Pipeline ejecutÃ¡ndose...**'
            }}


